{% load static i18n %}
{% get_current_language as CURRENT_LANGUAGE %}
<!DOCTYPE html>
<html lang="{{ CURRENT_LANGUAGE }}">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KINOTOO | Буду смотреть с семьей</title>

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Arsenal+SC:ital,wght@0,400;0,700;1,400;1,700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">

    <link rel="stylesheet" href="{% static 'favourite.css' %}">
    <link rel="stylesheet" href="{% static 'i18n.css' %}">
</head>
<body>

<header class="main-header">
    <div class="header-left">
        <div class="logo">
            <img src="{% static 'images/icon1.png' %}" alt="icon" class="icon_img">
            KINOTOO
        </div>

        <div class="search-box">
            <button class="search-icon">
                <a href="{% url 'home' %}">
                    <i class="fas fa-search"></i>
                </a>
            </button>
        </div>
    </div>

    <nav class="main-nav">
        <ul>
            <li><a href="{% url 'home' %}">{% trans "Фильмы" %}</a></li>
            <li><a href="{% url 'series' %}">{% trans "Сериалы" %}</a></li>
            <li><a href="{% url 'news' %}">{% trans "Новости" %}</a></li>
            <li><a href="{% url 'calendar' %}">{% trans "Календарь" %}</a></li>
        </ul>
    </nav>

    <div class="header-right">
        {% include 'partials/lang_switcher.html' %}
        <a href="{% url 'push' %}"><i class="fas fa-bell icon"></i></a>
        <a href="{% url 'profile' %}"><i class="fas fa-user-circle icon"></i></a>
        <a href="{% url 'favorites' %}"><i class="fas fa-bookmark icon"></i></a>
    </div>
</header>

<main class="main-content">
    <h1 class="page-title">{% trans "Буду смотреть с семьей" %}</h1>

    {% if entries %}
        <div class="list-carousel">
            <button type="button" class="list-nav prev-button" id="prevButton_family" disabled>
                <span class="arrow">&#9664;</span>
            </button>

            <div class="carousel-viewport list-viewport">
                <div class="carousel-track" id="carouselTrack_family">
                    {% for entry in entries %}
                        <a href="{% url 'movie_detail' entry.imdb_id %}" class="movie-card">
                            <button class="remove-favorite-btn" data-imdb="{{ entry.imdb_id }}" title="Удалить">
                                <i class="fas fa-times"></i>
                            </button>

                            <div class="movie-poster">
                                <img class="poster-image" src="{{ entry.poster|default_if_none:'' }}" alt="{{ entry.title }}">
                                <div class="poster-overlay">
                                    {% if entry.year %}
                                        <span class="rating-label">{{ entry.year }}</span>
                                    {% endif %}
                                </div>
                            </div>

                            <div class="movie-info">
                                <h3 class="movie-title">{{ entry.title }}</h3>
                            </div>
                        </a>
                    {% endfor %}
                </div>
            </div>

            <button type="button" class="list-nav next-button" id="nextButton_family">
                <span class="arrow">&#9654;</span>
            </button>
        </div>
    {% else %}
        <p>{% trans "Список пока пуст." %}</p>
    {% endif %}
</main>

<footer class="site-footer">
    <div class="footer-content-wrapper">
        <div class="footer-column about-us">
            <h3>{% trans "О нас" %}</h3>
            <ul>
                <li>{% trans "О компании" %}</li>
                <li>{% trans "Контакты" %}</li>
                <li>{% trans "Новости" %}</li>
                <li>{% trans "Пользовательское соглашение" %}</li>
                <li>{% trans "Политика конфиденциальности" %}</li>
            </ul>
        </div>

        <div class="footer-column help">
            <h3>{% trans "Помощь" %}</h3>
            <ul>
                <li>{% trans "Сообщить об ошибке" %}</li>
                <li>F.A.Q.</li>
            </ul>
        </div>

        <div class="footer-column social">
            <h3>{% trans "Социальные сети" %}</h3>
            <ul>
                <li>Instagram</li>
                <li>VK</li>
                <li>Telegram</li>
            </ul>
        </div>

        <div class="footer-column app-download">
            <h3>{% trans "Скачать приложение" %}</h3>
            <div class="app-buttons">
                <a href="#" class="app-button">
                    <img src="{% static 'images/footrer_icon.png' %}" alt="Google Play">
                </a>
                <a href="#" class="app-button">
                    <img src="{% static 'images/footer_icon2.png' %}" alt="App Store">
                </a>
            </div>
        </div>
    </div>

    <div class="footer-bottom">
        <hr class="footer-divider">
        <p class="copyright">
            <span class="copyright-icon">©</span> 2015 ООО "КиноТоо"
        </p>
    </div>
</footer>

<form id="csrf-form" style="display:none;">
    {% csrf_token %}
</form>

<script>
document.addEventListener("DOMContentLoaded", () => {
    const getCookie = (name) => {
        const cookies = document.cookie ? document.cookie.split(";") : [];
        for (const cookie of cookies) {
            const trimmed = cookie.trim();
            if (trimmed.startsWith(`${name}=`)) {
                return decodeURIComponent(trimmed.substring(name.length + 1));
            }
        }
        return null;
    };

    const getCsrfToken = () => {
        const hiddenToken = document.querySelector('#csrf-form input[name="csrfmiddlewaretoken"]');
        if (hiddenToken && hiddenToken.value) return hiddenToken.value;
        return getCookie("csrftoken");
    };

    document.querySelectorAll(".remove-favorite-btn").forEach(btn => {
        btn.addEventListener("click", (e) => {
            e.preventDefault();
            e.stopPropagation();

            const csrfToken = getCsrfToken();
            if (!csrfToken) return;

            fetch("{% url 'toggle_family' %}", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                    "X-CSRFToken": csrfToken,
                },
                body: JSON.stringify({
                    imdb_id: btn.dataset.imdb
                })
            })
            .then(res => {
                if (res.status === 403) {
                    window.location.href = "{% url 'login' %}";
                    return null;
                }
                return res.json();
            })
            .then(data => {
                if (!data) return;
                if (data.status === "removed") {
                    btn.closest(".movie-card").remove();
                }
            });
        });
    });
});
</script>

<script src="{% static 'script.js' %}?v=4"></script>
</body>
</html>
