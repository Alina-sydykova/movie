{% load static %}
<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KINOTOO</title>

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Arsenal+SC:ital,wght@0,400;0,700;1,400;1,700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">

    <link rel="stylesheet" href="{% static 'favourite.css' %}">
</head>
<body>
<form id="csrf-form" style="display:none;">
    {% csrf_token %}
</form>

<header class="main-header">
    <div class="header-left">
        <div class="logo">
            <img src="{% static 'images/icon1.png' %}" alt="icon" class="icon_img">
            KINOTOO
        </div>

        <div class="search-box">
            <button class="search-icon">
                <a href="{% url 'home' %}">
                    <i class="fas fa-search"></i>
                </a>
            </button>
        </div>
    </div>

    <nav class="main-nav">
        <ul>
            <li><a href="{% url 'home' %}">Фильмы</a></li>
            <li><a href="{% url 'series' %}">Сериалы</a></li>
            <li><a href="{% url 'news' %}">Новости</a></li>
            <li><a href="{% url 'calendar' %}">Календарь</a></li>
        </ul>
    </nav>

    <div class="header-right">
        <a href="{% url 'push' %}"><i class="fas fa-bell icon"></i></a>

        <a href="{% url 'profile' %}"><i class="fas fa-user-circle icon"></i></a>
        <a href="{% url 'favorites' %}"><i class="fas fa-bookmark icon"></i></a>
    </div>
</header>

<main class="main-content">
    <h1 class="page-title">Избранное</h1>

    {% if favorites %}
        <div class="list-carousel">
            <button type="button" class="list-nav prev-button" id="prevButton_favorites" disabled>
                <span class="arrow">&#9664;</span>
            </button>

            <div class="carousel-viewport list-viewport">
                <div class="carousel-track" id="carouselTrack_favorites">
                    {% for fav in favorites %}
                        <a href="{% url 'movie_detail' fav.imdb_id %}" class="movie-card">
                            <button
                                class="remove-favorite-btn"
                                data-imdb="{{ fav.imdb_id }}"
                                title="Удалить из избранного"
                            >
                                <i class="fas fa-times"></i>
                            </button>

                            <div class="movie-poster">
                                <img
                                    class="poster-image"
                                    src="{{ fav.poster|default_if_none:'' }}"
                                    alt="{{ fav.title }}"
                                >
                                <div class="poster-overlay">
                                    {% if fav.year %}
                                        <span class="rating-label">{{ fav.year }}</span>
                                    {% endif %}
                                </div>
                            </div>

                            <div class="movie-info">
                                <h3 class="movie-title">{{ fav.title }}</h3>
                            </div>
                        </a>
                    {% endfor %}
                </div>
            </div>

            <button type="button" class="list-nav next-button" id="nextButton_favorites">
                <span class="arrow">&#9654;</span>
            </button>
        </div>
    {% else %}
        <p>У вас пока нет избранных фильмов.</p>
    {% endif %}
</main>

<footer class="site-footer">
    <div class="footer-content-wrapper">
        <div class="footer-column about-us">
            <h3>О нас</h3>
            <ul>
                <li>О компании</li>
                <li>Контакты</li>
                <li>Новости</li>
                <li>Пользовательское соглашение</li>
                <li>Политика конфиденциальности</li>
            </ul>
        </div>

        <div class="footer-column help">
            <h3>Помощь</h3>
            <ul>
                <li>Сообщить об ошибке</li>
                <li>F.A.Q.</li>
            </ul>
        </div>

        <div class="footer-column social">
            <h3>Социальные сети</h3>
            <ul>
                <li>Instagram</li>
                <li>VK</li>
                <li>Telegram</li>
            </ul>
        </div>

        <div class="footer-column app-download">
            <h3>Скачать приложение</h3>
            <div class="app-buttons">
                <a href="#" class="app-button">
                    <img src="{% static 'images/footrer_icon.png' %}" alt="Google Play">
                </a>
                <a href="#" class="app-button">
                    <img src="{% static 'images/footer_icon2.png' %}" alt="App Store">
                </a>
            </div>
        </div>
    </div>

    <div class="footer-bottom">
        <hr class="footer-divider">
        <p class="copyright">
            <span class="copyright-icon">©</span> 2015 ООО "КиноТоо"
        </p>
    </div>
</footer>

<!-- JS: удаление из избранного -->
<script>
document.addEventListener("DOMContentLoaded", () => {
    document.querySelectorAll(".remove-favorite-btn").forEach(btn => {
        btn.addEventListener("click", (e) => {
            e.preventDefault();
            e.stopPropagation(); // чтобы не перейти на detail

            const hiddenToken = document.querySelector('#csrf-form input[name="csrfmiddlewaretoken"]');
            const csrfToken = hiddenToken ? hiddenToken.value : "{{ csrf_token }}";

            fetch("{% url 'toggle_favorite' %}", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                    "X-CSRFToken": csrfToken,
                },
                body: JSON.stringify({
                    imdb_id: btn.dataset.imdb
                })
            })
            .then(res => {
                if (res.status === 403) {
                    window.location.href = "{% url 'login' %}";
                    return null;
                }
                return res.json();
            })
            .then(data => {
                if (!data) return;
                if (data.status === "removed") {
                    btn.closest(".movie-card").remove();
                }
            });
        });
    });
});
</script>

<script src="{% static 'script.js' %}?v=2"></script>
</body>
</html>
